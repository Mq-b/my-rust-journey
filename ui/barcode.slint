import {
    Button,
    LineEdit,
    ComboBox,
    CheckBox,
    VerticalBox,
    HorizontalBox,
    Palette,
    ScrollView,
} from "std-widgets.slint";

export component BarcodeWindow inherits Window {
    // ── Standard mode properties ─────────────────────────────────────────
    in-out property <string> content: "A06975H91015UN24";
    in-out property <int> format-index: 0;
    in-out property <int> scale-index: 1;
    in-out property <int> rotate-index: 0;
    in-out property <int> columns-index: 1;
    in-out property <int> eclevel-index: 6;
    in-out property <string> width-cm: "5.0";
    in-out property <string> height-cm: "2.0";
    in-out property <image> preview;
    in-out property <bool> has-preview: false;

    // ── Abbott mode properties ───────────────────────────────────────────
    in-out property <bool> abbott-mode: false;
    in-out property <int> abbott-project-index: 0;
    in-out property <[string]> abbott-project-names: [];
    in-out property <int> abbott-reagent-count: 1;
    in-out property <string> abbott-sn1: "";
    in-out property <string> abbott-sn2: "";
    in-out property <string> abbott-sn3: "";
    in-out property <string> abbott-control-no: "";
    in-out property <string> abbott-expiry: "";
    in-out property <string> abbott-project-bits: "";
    in-out property <[string]> abbott-result-labels: [];
    in-out property <[string]> abbott-result-contents: [];
    in-out property <[image]> abbott-result-images: [];

    // ── Shared UI state ──────────────────────────────────────────────────
    in-out property <string> status: "就绪，点击生成条码";
    in-out property <string> toast-message: "";
    in-out property <bool> toast-visible: false;

    // ── Callbacks ────────────────────────────────────────────────────────
    callback generate();
    callback copy-to-clipboard();
    callback export-image();
    callback quit();
    callback reset-config();
    callback show-about();
    callback toggle-abbott-mode();
    callback abbott-auth-submit(string, string);  // username, password
    callback abbott-generate();
    callback abbott-export-all();
    callback abbott-project-changed(int);
    callback abbott-copy-content(int);

    // ── Auth dialog state ────────────────────────────────────────────────
    in-out property <bool> auth-dialog-visible: false;
    in-out property <string> auth-error: "";
    in-out property <string> auth-saved-username: "";
    in-out property <string> auth-saved-password: "";
    in-out property <bool> auth-remember: false;

    width: 560px;
    height: 720px;
    title: "雅培条码生成器";
    icon: @image-url("../assets/icon.svg");

    // ── Menu bar ─────────────────────────────────────────────────────────
    MenuBar {
        Menu {
            title: "文件";
            MenuItem {
                title: "生成条码";
                activated => { root.generate(); }
            }
            MenuItem {
                title: "复制到剪贴板";
                enabled: root.has-preview;
                activated => { root.copy-to-clipboard(); }
            }
            MenuItem {
                title: "导出图片";
                activated => { root.export-image(); }
            }
            MenuSeparator { }
            MenuItem {
                title: "退出";
                activated => { root.quit(); }
            }
        }

        Menu {
            title: "设置";
            MenuItem {
                title: root.abbott-mode ? "✓ 雅培项目" : "  雅培项目";
                activated => {
                    if root.abbott-mode {
                        // Already in Abbott mode: toggle off directly
                        root.toggle-abbott-mode();
                    } else {
                        // Need authentication before entering Abbott mode
                        root.auth-error = "";
                        root.auth-dialog-visible = true;
                    }
                }
            }
            MenuItem {
                title: "重置配置";
                activated => { root.reset-config(); }
            }
        }

        Menu {
            title: "帮助";
            MenuItem {
                title: "关于";
                activated => { root.show-about(); }
            }
        }
    }

    // ── Body ─────────────────────────────────────────────────────────────
    VerticalBox {
        width: parent.width;
        padding: 12px;
        spacing: 8px;

        Text {
            text: "雅培条码生成器";
            font-size: 16px;
            font-weight: 700;
            horizontal-alignment: center;
        }

        // ── Standard mode ────────────────────────────────────────────────
        if !root.abbott-mode: VerticalBox {
            padding: 0px;
            spacing: 8px;

            LineEdit {
                text <=> content;
                placeholder-text: "输入条码内容";
            }

            HorizontalBox {
                padding: 4px;
                spacing: 8px;
                HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "类型:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    ComboBox {
                        model: ["CompactPDF417","PDF417","QRCode","DataMatrix","Code128","Code39","Aztec","EAN13"];
                        current-index <=> format-index;
                        horizontal-stretch: 1;
                    }
                }
                HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "缩放:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    ComboBox {
                        model: ["1x","2x","3x","4x","5x"];
                        current-index <=> scale-index;
                        horizontal-stretch: 1;
                    }
                }
            }

            HorizontalBox {
                padding: 4px;
                spacing: 8px;
                HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "旋转:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    ComboBox {
                        model: ["0°","90°","180°","270°"];
                        current-index <=> rotate-index;
                        horizontal-stretch: 1;
                    }
                }
                if format-index <= 1: HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "列数:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    ComboBox {
                        model: ["1","2","3","4","5","6","7","8","9","10"];
                        current-index <=> columns-index;
                        horizontal-stretch: 1;
                    }
                }
            }

            if format-index <= 1: HorizontalBox {
                padding: 4px;
                spacing: 6px;
                Text {
                    text: "纠错等级:";
                    vertical-alignment: center;
                    min-width: 54px;
                    horizontal-stretch: 0;
                    font-weight: 700;
                    font-size: 13px;
                }
                ComboBox {
                    model: ["0","1","2","3","4","5","6","7","8"];
                    current-index <=> eclevel-index;
                    min-width: 72px;
                    max-width: 120px;
                    horizontal-stretch: 0;
                }
            }

            HorizontalBox {
                padding: 4px;
                spacing: 8px;
                HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "宽度:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    LineEdit {
                        text <=> width-cm;
                        placeholder-text: "输入宽度";
                        horizontal-stretch: 1;
                    }
                    Text { text: "cm"; vertical-alignment: center; font-size: 13px; color: #888; }
                }
                HorizontalBox {
                    padding: 0;
                    spacing: 6px;
                    horizontal-stretch: 1;
                    Text {
                        text: "高度:";
                        vertical-alignment: center;
                        min-width: 36px;
                        horizontal-stretch: 0;
                        font-weight: 700;
                        font-size: 13px;
                    }
                    LineEdit {
                        text <=> height-cm;
                        placeholder-text: "输入高度";
                        horizontal-stretch: 1;
                    }
                    Text { text: "cm"; vertical-alignment: center; font-size: 13px; color: #888; }
                }
            }

            HorizontalBox {
                padding: 0;
                spacing: 10px;
                Button {
                    text: "生成条码";
                    primary: true;
                    clicked => { generate(); }
                }
                Button {
                    text: "复制到剪贴板";
                    enabled: has-preview;
                    clicked => { copy-to-clipboard(); }
                }
                Button {
                    text: "导出图片";
                    clicked => { export-image(); }
                }
            }

            Rectangle {
                background: Palette.alternate-background;
                border-radius: 6px;
                border-width: 1px;
                border-color: Palette.border;
                vertical-stretch: 1;
                min-height: 200px;
                if !has-preview: Text {
                    text: "预览区域";
                    color: #808080;
                    font-size: 13px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                if has-preview: Image {
                    source: preview;
                    image-fit: contain;
                    image-rendering: pixelated;
                    width: 100%;
                    height: 100%;
                }
            }
        }

        // ── Abbott mode ──────────────────────────────────────────────────
        if root.abbott-mode: VerticalBox {
            padding: 0px;
            spacing: 6px;

            // 项目选择
            HorizontalBox {
                padding: 0;
                spacing: 8px;
                Text {
                    text: "项目:";
                    vertical-alignment: center;
                    min-width: 72px;
                    font-weight: 700;
                    font-size: 13px;
                    horizontal-stretch: 0;
                }
                ComboBox {
                    model: root.abbott-project-names;
                    current-index <=> root.abbott-project-index;
                    horizontal-stretch: 1;
                    changed current-index => {
                        root.abbott-project-changed(root.abbott-project-index);
                    }
                }
            }

            // Control No. 批号
            HorizontalBox {
                padding: 0;
                spacing: 8px;
                Text {
                    text: "批号:";
                    vertical-alignment: center;
                    min-width: 72px;
                    font-weight: 700;
                    font-size: 13px;
                    horizontal-stretch: 0;
                }
                LineEdit {
                    text <=> root.abbott-control-no;
                    placeholder-text: "如: 80001";
                    horizontal-stretch: 1;
                }
            }

            // 有效期
            HorizontalBox {
                padding: 0;
                spacing: 8px;
                Text {
                    text: "有效期:";
                    vertical-alignment: center;
                    min-width: 72px;
                    font-weight: 700;
                    font-size: 13px;
                    horizontal-stretch: 0;
                }
                LineEdit {
                    text <=> root.abbott-expiry;
                    placeholder-text: "格式: YYYY-MM-DD";
                    horizontal-stretch: 1;
                }
            }

            // 项目位（可选覆盖）
            HorizontalBox {
                padding: 0;
                spacing: 8px;
                Text {
                    text: "项目位:";
                    vertical-alignment: center;
                    min-width: 72px;
                    font-weight: 700;
                    font-size: 13px;
                    horizontal-stretch: 0;
                }
                LineEdit {
                    text <=> root.abbott-project-bits;
                    placeholder-text: "留空则使用默认项目位";
                    horizontal-stretch: 1;
                }
            }

            // SN码区域
            Rectangle {
                background: Palette.alternate-background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;

                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;

                    // SN码标题行
                    HorizontalBox {
                        padding: 0;
                        spacing: 0;
                        Text {
                            text: "SN 码";
                            font-weight: 700;
                            font-size: 12px;
                            color: #888;
                        }
                        Text {
                            text: root.abbott-reagent-count > 1 ? "（每组试剂各填一个，Control No. 必须相同）" : "";
                            font-size: 11px;
                            color: #aaa;
                            vertical-alignment: center;
                        }
                    }

                    // SN码 1 (always shown)
                    HorizontalBox {
                        padding: 0;
                        spacing: 8px;
                        Text {
                            text: root.abbott-reagent-count > 1 ? "SN 1:" : "SN:";
                            vertical-alignment: center;
                            min-width: 40px;
                            horizontal-stretch: 0;
                            font-size: 13px;
                        }
                        LineEdit {
                            text <=> root.abbott-sn1;
                            placeholder-text: "请输入SN码（如 01137）";
                            horizontal-stretch: 1;
                        }
                    }

                    // SN码 2 (multi-reagent only)
                    if root.abbott-reagent-count >= 2: HorizontalBox {
                        padding: 0;
                        spacing: 8px;
                        Text {
                            text: "SN 2:";
                            vertical-alignment: center;
                            min-width: 40px;
                            horizontal-stretch: 0;
                            font-size: 13px;
                        }
                        LineEdit {
                            text <=> root.abbott-sn2;
                            placeholder-text: "请输入SN码";
                            horizontal-stretch: 1;
                        }
                    }

                    // SN码 3 (3-reagent only)
                    if root.abbott-reagent-count >= 3: HorizontalBox {
                        padding: 0;
                        spacing: 8px;
                        Text {
                            text: "SN 3:";
                            vertical-alignment: center;
                            min-width: 40px;
                            horizontal-stretch: 0;
                            font-size: 13px;
                        }
                        LineEdit {
                            text <=> root.abbott-sn3;
                            placeholder-text: "请输入SN码";
                            horizontal-stretch: 1;
                        }
                    }
                }
            }

            // 操作按钮
            HorizontalBox {
                padding: 0;
                spacing: 10px;
                Button {
                    text: "生成条码";
                    primary: true;
                    clicked => { root.abbott-generate(); }
                }
                Button {
                    text: "导出全部图片";
                    clicked => { root.abbott-export-all(); }
                }
            }

            // 结果区域
            Rectangle {
                background: Palette.alternate-background;
                border-radius: 6px;
                border-width: 1px;
                border-color: Palette.border;
                vertical-stretch: 1;
                min-height: 220px;
                clip: true;

                if root.abbott-result-labels.length == 0: Text {
                    text: "填写上方信息后点击「生成条码」";
                    color: #808080;
                    font-size: 13px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                if root.abbott-result-labels.length > 0: ScrollView {
                    width: 100%;
                    height: 100%;

                    VerticalLayout {
                        padding: 8px;
                        spacing: 12px;

                        for lbl[i] in root.abbott-result-labels: Rectangle {
                            background: Palette.background;
                            border-radius: 4px;
                            border-width: 1px;
                            border-color: Palette.border;

                            VerticalLayout {
                                padding: 8px;
                                spacing: 6px;

                                // 标题行 + 复制按钮
                                HorizontalLayout {
                                    spacing: 8px;
                                    alignment: stretch;

                                    Text {
                                        text: lbl;
                                        font-weight: 700;
                                        font-size: 13px;
                                        color: Palette.foreground;
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    Button {
                                        text: "复制内容";
                                        clicked => { root.abbott-copy-content(i); }
                                    }
                                }

                                // 条码内容文本（完整显示，可换行）
                                Rectangle {
                                    background: Palette.alternate-background;
                                    border-radius: 3px;

                                    HorizontalLayout {
                                        padding: 4px;
                                        Text {
                                            text: root.abbott-result-contents[i];
                                            font-size: 12px;
                                            font-weight: 700;
                                            font-family: "monospace";
                                            color: Palette.foreground;
                                            wrap: word-wrap;
                                        }
                                    }
                                }

                                // 条码预览图
                                Image {
                                    source: root.abbott-result-images[i];
                                    image-fit: contain;
                                    image-rendering: pixelated;
                                    height: 72px;
                                    horizontal-alignment: left;
                                }
                            }
                        }
                    }
                }
            }
        }

        // ── Status bar ───────────────────────────────────────────────────
        Text {
            text: status;
            color: #888;
            font-size: 12px;
            horizontal-alignment: center;
        }
    }

    // ── Toast notification ───────────────────────────────────────────────
    property <float> toast-alpha: toast-visible ? 1.0 : 0.0;
    animate toast-alpha {
        duration: 300ms;
        easing: ease-out;
    }

    Timer {
        interval: 1500ms;
        running: toast-visible;
        triggered => { root.toast-visible = false; }
    }

    Rectangle {
        opacity: root.toast-alpha;
        x: (parent.width - 280px) / 2;
        y: parent.height - 72px;
        width: 280px;
        height: 40px;
        background: #333333;
        border-radius: 20px;
        Text {
            text: toast-message;
            color: #ffffff;
            font-size: 13px;
            horizontal-alignment: center;
            vertical-alignment: center;
            width: 100%;
            height: 100%;
        }
        TouchArea {
            enabled: root.toast-visible;
            clicked => { root.toast-visible = false; }
        }
    }

    // ── Auth dialog overlay (rendered last = on top) ──────────────────────
    if root.auth-dialog-visible: Rectangle {
        // Full-window overlay
        x: 0;
        y: 0;
        width: root.width;
        height: root.height;
        background: #00000066;

        Rectangle {
            width: 300px;
            height: root.auth-error != "" ? 268px : 240px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: Palette.background;
            border-radius: 8px;
            border-width: 1px;
            border-color: Palette.border;

            VerticalLayout {
                padding: 20px;
                spacing: 12px;
                alignment: start;

                Text {
                    text: "雅培项目 - 身份验证";
                    font-size: 14px;
                    font-weight: 700;
                    horizontal-alignment: center;
                }

                dlg-username := LineEdit {
                    placeholder-text: "账号";
                    input-type: text;
                    text: root.auth-saved-username;
                }

                dlg-password := LineEdit {
                    placeholder-text: "密码";
                    input-type: password;
                    text: root.auth-saved-password;
                    accepted => {
                        root.abbott-auth-submit(dlg-username.text, dlg-password.text);
                    }
                }

                if root.auth-error != "": Text {
                    text: root.auth-error;
                    color: #e05252;
                    font-size: 12px;
                    horizontal-alignment: center;
                }

                // Remember credentials checkbox row
                HorizontalLayout {
                    spacing: 6px;
                    alignment: start;

                    remember-cb := CheckBox {
                        checked: root.auth-remember;
                        toggled => { root.auth-remember = self.checked; }
                    }

                    Text {
                        text: "记住账号和密码";
                        font-size: 13px;
                        vertical-alignment: center;
                    }
                }

                HorizontalLayout {
                    spacing: 10px;

                    Button {
                        text: "取消";
                        horizontal-stretch: 1;
                        clicked => {
                            root.auth-dialog-visible = false;
                            root.auth-error = "";
                            dlg-username.text = "";
                            dlg-password.text = "";
                        }
                    }

                    Button {
                        text: "确认";
                        primary: true;
                        horizontal-stretch: 1;
                        clicked => {
                            root.abbott-auth-submit(dlg-username.text, dlg-password.text);
                        }
                    }
                }
            }
        }
    }
}
